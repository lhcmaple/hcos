	AREA RESET,DATA,READONLY
VECTORS_START
	DCD MSP_TOP
	DCD RESET_HANDLER
	DCD 0
	DCD 0
	DCD 0
	DCD 0
	DCD 0
	DCD 0
	DCD 0
	DCD 0
	DCD 0
	DCD 0
	DCD 0
	DCD 0
	DCD PENDSV_HANDLER
	DCD SYS_HANDLER
VECTORS_END
VECTORS_SIZE EQU VECTORS_END-VECTORS_START


	AREA CODESEG,CODE,READONLY
NVIC_ICSR EQU 0xE000ED04
	IMPORT main
	IMPORT current

RESET_HANDLER PROC
	BL HANDLER_SETUP
	B main
	ENDP

HANDLER_SETUP PROC
	LDR R0,=0xE000ED18
	LDR R1,[R0,#0x08]
	MOV R2,#0xff;PendSV为最低优先级
	STRB R2,[R0,#0x02]
	BX LR
	ENDP

SYS_HANDLER PROC
	IMPORT systime
	LDR R0,=NVIC_ICSR
	MOV R1,#0x10000000
	STR R1,[R0]
	LDR R0,=systime
	LDR R1,[R0]
	ADD R1,#0x1
	STR R1,[R0]
 	BX LR
	ENDP
	NOP

PENDSV_HANDLER PROC
	MRS R0,PSP
	STMDB R0!,{R4-R11}
	LDR R1,=current
	LDR R2,[R1]
	STR R0,[R2]
	LDR R0,[R2,#0x04]
	STR R0,[R1]
	LDR R0,[R0]
	LDMIA R0!,{R4-R11}
	MSR PSP,R0
	BX LR
	ENDP


	AREA STACKSEG,NOINIT,READWRITE,ALIGN=3
MSP_SIZE EQU 0x00004000
MSP_BASE
	SPACE MSP_SIZE
MSP_TOP


	END
